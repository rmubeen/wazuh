/*
 * SQL Schema for vulnerability detector module
 * Copyright (C) 2015-2019, Wazuh Inc.
 * January 28, 2018.
 * This program is a free software, you can redistribute it
 * and/or modify it under the terms of GPLv2.
 */

BEGIN;

CREATE TABLE IF NOT EXISTS AGENTS (
         AGENT_ID INT NOT NULL,
         PACKAGE_NAME TEXT NOT NULL,
         TARGET_MAJOR TEXT,
         TARGET_MINOR TEXT,
         VERSION TEXT NOT NULL,
         ARCH TEXT NOT NULL,
         PRIMARY KEY(AGENT_ID, PACKAGE_NAME, VERSION, ARCH)
);

 CREATE TABLE IF NOT EXISTS METADATA (
         OS TEXT PRIMARY KEY NOT NULL,
         PRODUCT_NAME TEXT NOT NULL,
         PRODUCT_VERSION TEXT,
         SCHEMA_VERSION TEXT,
         TIMESTAMP DATE NOT NULL
 );

 CREATE TABLE IF NOT EXISTS DB_METADATA (
         VERSION TEXT PRIMARY KEY NOT NULL
 );

 CREATE TABLE IF NOT EXISTS VULNERABILITIES_INFO (
         ID TEXT NOT NULL,
         TITLE TEXT,
         SEVERITY TEXT,
         PUBLISHED TEXT,
         UPDATED TEXT,
         REFERENCE TEXT,
         OS TEXT NOT NULL,
         RATIONALE TEXT,
         CVSS TEXT,
         CVSS_VECTOR TEXT,
         CVSS3 TEXT,
         BUGZILLA_REFERENCE TEXT,
         CWE TEXT,
         ADVISORIES TEXT,
         PRIMARY KEY(ID, OS)
 );

CREATE TABLE IF NOT EXISTS VULNERABILITIES (
        CVEID TEXT NOT NULL REFERENCES VULNERABILITIES_INFO(ID),
        OS TEXT NOT NULL REFERENCES VULNERABILITIES_INFO(V_OS),
        OS_MINOR TEXT,
        PACKAGE TEXT NOT NULL,
        PENDING BOOLEAN NOT NULL,
        OPERATION TEXT NOT NULL,
        OPERATION_VALUE TEXT,
        SECOND_OPERATION TEXT,
        SECOND_OPERATION_VALUE TEXT,
        PRIMARY KEY(CVEID, OS, PACKAGE, OPERATION_VALUE)
);

CREATE INDEX IF NOT EXISTS IN_VIN_CVE ON VULNERABILITIES_INFO (ID);
CREATE INDEX IF NOT EXISTS IN_VIN_TARGET ON VULNERABILITIES_INFO (OS);

CREATE INDEX IF NOT EXISTS IN_AG_ID ON AGENTS (AGENT_ID);
CREATE INDEX IF NOT EXISTS IN_AG_PACK ON AGENTS (PACKAGE_NAME);
CREATE INDEX IF NOT EXISTS IN_AG_VER ON AGENTS (VERSION);
CREATE INDEX IF NOT EXISTS IN_AG_ARCH ON AGENTS (ARCH);

CREATE INDEX IF NOT EXISTS IN_VUL_PACK ON VULNERABILITIES (PACKAGE);
CREATE INDEX IF NOT EXISTS IN_VUL_CVEID ON VULNERABILITIES (CVEID);
CREATE INDEX IF NOT EXISTS IN_VUL_OP ON VULNERABILITIES (OPERATION);
CREATE INDEX IF NOT EXISTS IN_VUL_OP_VAL ON VULNERABILITIES (OPERATION_VALUE);
CREATE INDEX IF NOT EXISTS IN_VUL_SOP ON VULNERABILITIES (SECOND_OPERATION);
CREATE INDEX IF NOT EXISTS IN_VUL_SOP_VAL ON VULNERABILITIES (SECOND_OPERATION_VALUE);
CREATE INDEX IF NOT EXISTS IN_VUL_TARGET ON VULNERABILITIES (OS);
CREATE INDEX IF NOT EXISTS IN_VUL_TARGET_MINOR ON VULNERABILITIES (OS_MINOR);

DELETE FROM DB_METADATA;

END;
